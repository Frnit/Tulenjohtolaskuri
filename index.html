<!DOCTYPE html>
<html lang="fi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>TJ-Laskuri Pro v8</title>
    
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#1e1e1e">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="icon.png"> 

    <style>
        :root {
            --bg: #121212; --panel: #1e1e1e; --input-bg: #2d2d2d;
            --text-main: #e0e0e0; --text-muted: #888; --border: #333;
            --accent: #2980b9; --success: #27ae60; --warning: #f39c12; --danger: #c0392b;
            --active-sensor: #c0392b; /* Punainen kun sensori on p√§√§ll√§ */
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background-color: var(--bg); color: var(--text-main); margin: 0; padding: 10px;
            display: flex; justify-content: center;
        }
        .container {
            background: var(--panel); padding: 15px; border-radius: 8px; width: 100%; max-width: 500px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.6); padding-bottom: 30px;
        }
        h2 { text-align: center; margin: 5px 0 15px 0; font-size: 1.1rem; text-transform: uppercase; letter-spacing: 1px; color: var(--text-muted); }

        /* Input Styles */
        label { display: block; margin-top: 8px; margin-bottom: 2px; font-size: 0.7rem; color: var(--text-muted); text-transform: uppercase; font-weight: 600; }
        input, select {
            width: 100%; padding: 10px; background: var(--input-bg); border: 1px solid var(--border); color: #fff;
            border-radius: 4px; box-sizing: border-box; font-size: 16px;
        }
        input:focus, select:focus { border-color: var(--accent); outline: none; }
        
        /* Layout */
        .row { display: flex; gap: 8px; align-items: flex-end; }
        .col { flex: 1; }
        .coord-group { display: flex; gap: 4px; }
        .coord-group input { text-align: center; padding: 10px 2px; }

        /* Buttons */
        .btn-group { display: flex; gap: 5px; margin-bottom: 15px; background: #252525; padding: 5px; border-radius: 6px; }
        .btn { padding: 10px; border: none; border-radius: 4px; color: white; font-weight: bold; cursor: pointer; font-size: 0.8rem;}
        .btn-save { background: var(--success); flex: 1; } 
        .btn-del { background: var(--danger); width: 40px; }

        /* SENSOR BUTTONS */
        .sensor-btn {
            background: #333; color: #ccc; border: 1px solid #444; width: 100%; margin-top: 5px;
            padding: 8px; border-radius: 4px; font-weight: bold; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 5px;
        }
        .sensor-btn.active {
            background: var(--active-sensor); color: white; border-color: var(--active-sensor);
            animation: pulse 2s infinite;
        }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.8; } 100% { opacity: 1; } }
        
        /* Result Box */
        .result-box {
            background: #252d3a; border-radius: 6px; padding: 15px; margin-top: 20px; border: 1px solid #3a4b61;
        }
        .res-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px; border-bottom: 1px solid #3a4b61; padding-bottom: 6px; }
        .res-label { font-size: 0.8rem; color: #a0a0a0; }
        .res-val { font-weight: bold; font-family: monospace; font-size: 1.1rem; color: #fff; }
        .res-highlight { color: var(--success); font-size: 1.4rem; }
        
        /* Johnson Meter */
        .meter { display: flex; height: 6px; gap: 2px; margin-top: 8px; }
        .step { flex: 1; background: #333; border-radius: 2px; }
        .active.l1 { background: var(--danger); } .active.l2 { background: var(--warning); } .active.l3 { background: var(--success); }
        .j-text { text-align: center; font-size: 0.75rem; margin-top: 4px; font-weight: bold; color: #666; }

        /* Modal */
        .info-btn { position: absolute; top: 15px; right: 15px; background: #333; color: #fff; border:none; width:25px; height:25px; border-radius:50%; font-weight:bold; }
        .modal { display: none; position: fixed; z-index: 100; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); }
        .modal-content { background: var(--panel); margin: 15% auto; padding: 20px; width: 85%; border-radius: 8px; border: 1px solid #444; }
    </style>
</head>
<body>

<div class="container">
    <button class="info-btn" onclick="document.getElementById('infoModal').style.display='block'">i</button>
    <h2>TJ-Laskuri Pro</h2>

    <div class="btn-group">
        <select id="profileSelector" onchange="loadProfile()" style="flex: 3; background: transparent; border: none;">
            <option value="">-- Valitse Profiili --</option>
        </select>
        <button class="btn btn-save" onclick="saveProfile()">TAL</button>
        <button class="btn btn-del" onclick="deleteProfile()">X</button>
    </div>

    <div style="margin-bottom: 15px; border-bottom: 1px solid #333; padding-bottom: 15px;">
        <label>Oma Sijainti (WGS84)</label>
        <div class="row" style="margin-bottom: 5px;">
            <div class="coord-group col">
                <input type="number" id="latD" placeholder="Lat ¬∞" oninput="calc()">
                <input type="number" id="latM" placeholder="'" oninput="calc()">
                <input type="number" id="latS" placeholder='"' oninput="calc()">
            </div>
        </div>
        <div class="row">
            <div class="coord-group col">
                <input type="number" id="lonD" placeholder="Lon ¬∞" oninput="calc()">
                <input type="number" id="lonM" placeholder="'" oninput="calc()">
                <input type="number" id="lonS" placeholder='"' oninput="calc()">
            </div>
        </div>
        <button id="btnGps" class="sensor-btn" onclick="toggleGPS()">
            <span>üìç</span> Hae GPS Sijainti
        </button>

        <div class="row" style="margin-top:15px;">
            <div class="col" style="flex: 2;">
                <label>T√§hystyssuunta</label>
                <input type="number" id="azimuth" placeholder="Suunta" oninput="calc()">
            </div>
            <div class="col" style="flex: 1;">
                <label>Yksikk√∂</label>
                <select id="azUnit" onchange="calc()">
                    <option value="mil">Mil</option>
                    <option value="deg">Deg</option>
                    <option value="piiru">PV</option>
                </select>
            </div>
        </div>
        <button id="btnCompass" class="sensor-btn" onclick="toggleCompass()">
            <span>üß≠</span> Hae Kompassi
        </button>
    </div>

    <div class="row">
        <div class="col" style="flex:2;">
            <label>Kameran FOV</label>
            <input type="number" id="fov" placeholder="FOV" oninput="calc()">
        </div>
        <div class="col" style="flex:1.5;">
            <label>Yksikk√∂</label>
            <select id="fovUnit" onchange="calc()">
                <option value="deg">¬∞</option>
                <option value="mil">Mil</option>
                <option value="piiru">PV</option>
                <option value="mrad">Mrad</option>
            </select>
        </div>
        <div class="col" style="flex:1.5;">
            <label>Kuva px</label>
            <input type="number" id="res" value="1920" oninput="calc()">
        </div>
    </div>

    <div class="row">
        <div class="col" style="flex: 2;">
            <label>Maali (m)</label>
            <div class="coord-group">
                <select id="pre" onchange="applyPre()" style="width: 30%; padding: 5px;">
                    <option value="" disabled selected>‚ñæ</option>
                    <option value="0.5">0.5</option>
                    <option value="2.3">2.3</option>
                    <option value="20">20</option>
                </select>
                <input type="number" id="tReal" placeholder="m" oninput="calc()">
            </div>
        </div>
        <div class="col" style="flex: 1.5;">
            <label>Maali px</label>
            <input type="number" id="tPx" placeholder="px" oninput="calc()">
        </div>
        <div class="col" style="flex: 1.5;">
            <label>Koro (¬∞)</label>
            <input type="number" id="elev" placeholder="¬±deg" oninput="calc()">
        </div>
    </div>

    <div class="result-box">
        <div class="res-row"><span class="res-label">Viistoet√§isyys</span><span class="res-val" id="rSlant">---</span></div>
        <div class="res-row"><span class="res-label">Maastoet√§isyys</span><span class="res-val res-highlight" id="rGround">---</span></div>
        <div class="res-row"><span class="res-label">Korkeusero</span><span class="res-val" id="rHeight">---</span></div>
        
        <div style="margin-top:12px; border-top:1px solid #444; padding-top:8px;">
            <div class="res-label" style="text-align:center; margin-bottom:4px;">MAALIN WGS84</div>
            <div id="rCoords" style="color:#5dade2; font-family:monospace; font-size:1rem; text-align:center;">---</div>
            
            <div class="res-label" style="text-align:center; margin-top:8px; margin-bottom:4px;">GRID SIIRTYM√Ñ (MGRS)</div>
            <div id="rShift" style="color:#e0e0e0; font-family:monospace; font-size:1rem; text-align:center;">N: --- E: ---</div>
        </div>

        <div class="meter"><div id="j1" class="step"></div><div id="j2" class="step"></div><div id="j3" class="step"></div></div>
        <div id="jTxt" class="j-text">---</div>
    </div>
</div>

<div id="infoModal" class="modal" onclick="this.style.display='none'">
    <div class="modal-content">
        <h3>Ohjeet</h3>
        <p><strong>GPS & Kompassi:</strong> Vaatii HTTPS-yhteyden. Paina nappeja aktivoidaksesi.</p>
        <p><strong>iPhone K√§ytt√§j√§t:</strong> Kompassi vaatii luvan (Allow) ensimm√§isell√§ kerralla.</p>
        <p><strong>WGS84:</strong> Koordinaatit sy√∂tet√§√§n muodossa Asteet, Minuutit, Sekunnit.</p>
        <p style="text-align:right; margin-top:20px; color:#2980b9;">Sulje</p>
    </div>
</div>

<script>
    if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('./sw.js').catch(console.error);
    }

    // --- MATH & UTILS ---
    const toRad = d => d * Math.PI / 180;
    const toDeg = r => r * 180 / Math.PI;

    function getRad(val, unit) {
        if (!val) return 0;
        if (unit === 'deg') return toRad(val);
        if (unit === 'mil') return val * (2 * Math.PI / 6400);
        if (unit === 'piiru') return val * (2 * Math.PI / 6000);
        if (unit === 'mrad') return val / 1000;
        return 0;
    }

    function ddToDmsSplit(deg) {
        const abs = Math.abs(deg);
        const d = Math.floor(abs);
        const m = Math.floor((abs - d) * 60);
        const s = ((abs - d - m/60) * 3600).toFixed(1);
        return { d: d * (deg < 0 ? -1 : 1), m: m, s: s };
    }

    function ddToDmsStr(deg, isLat) {
        const p = ddToDmsSplit(deg);
        const dir = isLat ? (deg >= 0 ? 'N' : 'S') : (deg >= 0 ? 'E' : 'W');
        return `${Math.abs(p.d)}¬∞${p.m}'${p.s}"${dir}`;
    }

    // --- SENSOR LOGIC ---
    let watchId = null;
    let compassActive = false;

    // 1. GPS TOGGLE
    function toggleGPS() {
        const btn = document.getElementById('btnGps');
        
        if (watchId) {
            // STOP
            navigator.geolocation.clearWatch(watchId);
            watchId = null;
            btn.classList.remove('active');
            btn.innerHTML = '<span>üìç</span> Hae GPS Sijainti';
        } else {
            // START
            if (!navigator.geolocation) { alert("Selaimesi ei tue GPS:√§√§"); return; }
            btn.classList.add('active');
            btn.innerHTML = '<span>üìç</span> P√§ivitet√§√§n...';
            
            watchId = navigator.geolocation.watchPosition((pos) => {
                const lat = pos.coords.latitude;
                const lon = pos.coords.longitude;
                
                // T√§yt√§ kent√§t (Lat)
                const latP = ddToDmsSplit(lat);
                document.getElementById('latD').value = latP.d;
                document.getElementById('latM').value = latP.m;
                document.getElementById('latS').value = latP.s;

                // T√§yt√§ kent√§t (Lon)
                const lonP = ddToDmsSplit(lon);
                document.getElementById('lonD').value = lonP.d;
                document.getElementById('lonM').value = lonP.m;
                document.getElementById('lonS').value = lonP.s;
                
                calc(); // P√§ivit√§ laskut heti
            }, (err) => {
                console.error(err);
                alert("GPS Virhe. Varmista HTTPS ja luvat.");
                toggleGPS(); // Reset button
            }, { enableHighAccuracy: true });
        }
    }

    // 2. COMPASS TOGGLE
    function toggleCompass() {
        const btn = document.getElementById('btnCompass');

        if (compassActive) {
            // STOP
            window.removeEventListener('deviceorientation', handleOrientation);
            compassActive = false;
            btn.classList.remove('active');
            btn.innerHTML = '<span>üß≠</span> Hae Kompassi';
        } else {
            // START
            // iOS Permission Check
            if (typeof DeviceOrientationEvent !== 'undefined' && typeof DeviceOrientationEvent.requestPermission === 'function') {
                DeviceOrientationEvent.requestPermission()
                    .then(response => {
                        if (response === 'granted') {
                            startCompass(btn);
                        } else {
                            alert("Lupa ev√§tty.");
                        }
                    })
                    .catch(console.error);
            } else {
                // Android / Non-iOS
                startCompass(btn);
            }
        }
    }

    function startCompass(btn) {
        window.addEventListener('deviceorientation', handleOrientation);
        compassActive = true;
        btn.classList.add('active');
        btn.innerHTML = '<span>üß≠</span> Seurataan...';
    }

    function handleOrientation(e) {
        let heading = 0;
        
        // iOS
        if (e.webkitCompassHeading) {
            heading = e.webkitCompassHeading;
        } 
        // Android / Standard (absolute)
        else if (e.alpha) {
            heading = 360 - e.alpha; // Yksinkertaistettu, saattaa vaatia 'absolute' lipun
        }

        if (heading) {
            // Normalisoi 0-360
            if (heading < 0) heading += 360;
            if (heading >= 360) heading -= 360;

            const unit = document.getElementById('azUnit').value;
            let displayVal = heading;

            // Muunna yksikk√∂√∂n
            if (unit === 'mil') displayVal = heading * (6400 / 360);
            if (unit === 'piiru') displayVal = heading * (6000 / 360);
            
            // Py√∂rist√§ ja aseta
            document.getElementById('azimuth').value = Math.round(displayVal);
            calc();
        }
    }

    // --- MAIN CALC ---
    function calc() {
        const fov = parseFloat(document.getElementById('fov').value);
        const res = parseFloat(document.getElementById('res').value);
        const tPx = parseFloat(document.getElementById('tPx').value);
        const tReal = parseFloat(document.getElementById('tReal').value);
        const elev = parseFloat(document.getElementById('elev').value) || 0;

        // Reset inputs
        if (!fov || !res || !tPx || !tReal) {
            document.getElementById('rSlant').innerText = "---";
            document.getElementById('rGround').innerText = "---";
            document.getElementById('rHeight').innerText = "---";
            return;
        }

        // 1. Optics
        const fovRad = getRad(fov, document.getElementById('fovUnit').value);
        const angle = (fovRad / res) * tPx;
        
        // D = (W/2) / tan(a/2)
        const slant = (tReal / 2) / Math.tan(angle / 2);
        const ground = slant * Math.cos(toRad(elev));
        const height = slant * Math.sin(toRad(elev));

        document.getElementById('rSlant').innerText = slant.toFixed(0) + " m";
        document.getElementById('rGround').innerText = Math.abs(ground).toFixed(0) + " m";
        document.getElementById('rHeight').innerText = (height>0?"+":"") + height.toFixed(0) + " m";

        updateJohnson(tPx);
        calcCoords(ground);
    }

    function calcCoords(dist) {
        // Oma Sijainti DMS -> DD
        const latD = parseFloat(document.getElementById('latD').value);
        const latM = parseFloat(document.getElementById('latM').value)||0;
        const latS = parseFloat(document.getElementById('latS').value)||0;
        const lonD = parseFloat(document.getElementById('lonD').value);
        const lonM = parseFloat(document.getElementById('lonM').value)||0;
        const lonS = parseFloat(document.getElementById('lonS').value)||0;
        
        const azVal = parseFloat(document.getElementById('azimuth').value);

        if (!azVal) {
            document.getElementById('rCoords').innerText = "---";
            document.getElementById('rShift').innerText = "N: --- E: ---";
            return;
        }

        const azRad = getRad(azVal, document.getElementById('azUnit').value);

        // 2. Grid Shift
        const dN = dist * Math.cos(azRad);
        const dE = dist * Math.sin(azRad);
        document.getElementById('rShift').innerText = `N: ${dN>0?'+':''}${dN.toFixed(0)}m  E: ${dE>0?'+':''}${dE.toFixed(0)}m`;

        // 3. WGS84 Destination
        if (!latD || !lonD) {
            document.getElementById('rCoords').innerText = "Sy√∂t√§ Oma Sijainti";
            return;
        }

        const lat1 = toRad(latD + latM/60 + latS/3600);
        const lon1 = toRad(lonD + lonM/60 + lonS/3600);
        const R = 6371000; 

        const lat2 = Math.asin(Math.sin(lat1)*Math.cos(dist/R) + Math.cos(lat1)*Math.sin(dist/R)*Math.cos(azRad));
        const lon2 = lon1 + Math.atan2(Math.sin(azRad)*Math.sin(dist/R)*Math.cos(lat1), Math.cos(dist/R)-Math.sin(lat1)*Math.sin(lat2));

        document.getElementById('rCoords').innerHTML = ddToDmsStr(toDeg(lat2), true) + "<br>" + ddToDmsStr(toDeg(lon2), false);
    }

    // --- UI HELPERS ---
    function updateJohnson(px) {
        const j1=document.getElementById('j1'), j2=document.getElementById('j2'), j3=document.getElementById('j3'), t=document.getElementById('jTxt');
        j1.className=j2.className=j3.className="step";
        if(px<2){t.innerText="---"; return;}
        j1.classList.add("active","l1"); t.innerText="HAVAITSEMINEN"; t.style.color="#c0392b";
        if(px>=8){j2.classList.add("active","l2"); t.innerText="LUOKITTELU"; t.style.color="#f39c12"; }
        if(px>=13){j3.classList.add("active","l3"); t.innerText="TUNNISTUS"; t.style.color="#27ae60";}
    }

    function applyPre() { document.getElementById('tReal').value = document.getElementById('pre').value; calc(); }

    // --- PROFILES ---
    let profs = JSON.parse(localStorage.getItem('tj_profs_v2') || '{}');
    function loadProfile() {
        const p = profs[document.getElementById('profileSelector').value];
        if(p) { 
            document.getElementById('fov').value=p.f; document.getElementById('res').value=p.r; document.getElementById('fovUnit').value=p.u; 
            calc();
        }
    }
    function saveProfile() {
        const n = prompt("Profiilin nimi?"); if(!n)return;
        profs[n] = { f:document.getElementById('fov').value, r:document.getElementById('res').value, u:document.getElementById('fovUnit').value };
        localStorage.setItem('tj_profs_v2', JSON.stringify(profs)); updateSel();
    }
    function updateSel() {
        const s = document.getElementById('profileSelector'); s.innerHTML='<option value="">-- Valitse Profiili --</option>';
        for(let k in profs) { let o=document.createElement('option'); o.value=k; o.text=k; s.add(o); }
    }
    function deleteProfile() { 
        const n=document.getElementById('profileSelector').value; 
        if(profs[n]) { delete profs[n]; localStorage.setItem('tj_profs_v2',JSON.stringify(profs)); updateSel(); }
    }
    window.onload = function() { updateSel(); calc(); };
</script>
</body>
</html>
