<!DOCTYPE html>
<html lang="fi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>TJ-Laskuri Pro v10</title>
    
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#1e1e1e">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="icon.png"> 

    <style>
        :root {
            --bg: #121212; --panel: #1e1e1e; --input-bg: #2d2d2d;
            --text-main: #e0e0e0; --text-muted: #888; --border: #333;
            --accent: #2980b9; --success: #27ae60; --warning: #f39c12; --danger: #c0392b;
            --active-sensor: #c0392b;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background-color: var(--bg); color: var(--text-main); margin: 0; padding: 10px;
            display: flex; justify-content: center;
        }
        .container {
            background: var(--panel); padding: 0; border-radius: 8px; width: 100%; max-width: 500px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.6); overflow: hidden; padding-bottom: 20px;
        }
        
        /* TABS */
        .tab-bar { display: flex; background: #111; border-bottom: 1px solid var(--border); }
        .tab {
            flex: 1; padding: 15px; text-align: center; cursor: pointer;
            background: #151515; color: #888; font-weight: bold; text-transform: uppercase; font-size: 0.85rem;
            border: none; border-bottom: 3px solid transparent; transition: 0.2s;
        }
        .tab.active { background: var(--panel); color: var(--accent); border-bottom-color: var(--accent); }

        .content-area { padding: 15px; }

        /* COMMON STYLES */
        h2 { text-align: center; margin: 5px 0 15px 0; font-size: 1.1rem; color: var(--text-muted); }
        label { display: block; margin-top: 8px; margin-bottom: 2px; font-size: 0.7rem; color: var(--text-muted); text-transform: uppercase; font-weight: 600; }
        input, select {
            width: 100%; padding: 10px; background: var(--input-bg); border: 1px solid var(--border); color: #fff;
            border-radius: 4px; box-sizing: border-box; font-size: 16px;
        }
        input:focus, select:focus { border-color: var(--accent); outline: none; }
        .row { display: flex; gap: 8px; align-items: flex-end; }
        .col { flex: 1; }
        .coord-group { display: flex; gap: 4px; }
        .coord-group input { text-align: center; padding: 10px 2px; }

        /* BUTTONS */
        .btn-group { display: flex; gap: 5px; margin-bottom: 15px; background: #252525; padding: 5px; border-radius: 6px; }
        .btn { padding: 10px; border: none; border-radius: 4px; color: white; font-weight: bold; cursor: pointer; font-size: 0.8rem;}
        .btn-save { background: var(--success); flex: 1; } 
        .btn-del { background: var(--danger); width: 40px; }
        .sensor-btn {
            background: #333; color: #ccc; border: 1px solid #444; width: 100%; margin-top: 5px;
            padding: 8px; border-radius: 4px; font-weight: bold; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 5px;
        }
        .sensor-btn.active { background: var(--active-sensor); color: white; border-color: var(--active-sensor); animation: pulse 2s infinite; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.8; } 100% { opacity: 1; } }
        
        /* SHARE BUTTON */
        .share-btn {
            background: var(--accent); color: white; border: none; width: 100%; margin-top: 15px;
            padding: 12px; border-radius: 6px; font-weight: bold; font-size: 1rem; cursor: pointer;
            display: flex; align-items: center; justify-content: center; gap: 8px;
        }
        .share-btn:active { opacity: 0.8; }

        /* RESULT BOX */
        .result-box {
            background: #252d3a; border-radius: 6px; padding: 15px; margin-top: 20px; border: 1px solid #3a4b61;
        }
        .res-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px; border-bottom: 1px solid #3a4b61; padding-bottom: 6px; }
        .res-label { font-size: 0.8rem; color: #a0a0a0; }
        .res-val { font-weight: bold; font-family: monospace; font-size: 1.1rem; color: #fff; }
        .res-highlight { color: var(--success); font-size: 1.4rem; }
        
        /* MGRS Display */
        .mgrs-box {
            background: #1a212b; border: 1px solid #5dade2; color: #5dade2;
            font-family: monospace; font-size: 1.3rem; font-weight: bold;
            padding: 10px; text-align: center; border-radius: 4px; margin: 10px 0;
            letter-spacing: 1px;
        }

        .meter { display: flex; height: 6px; gap: 2px; margin-top: 8px; }
        .step { flex: 1; background: #333; border-radius: 2px; }
        .active.l1 { background: var(--danger); } .active.l2 { background: var(--warning); } .active.l3 { background: var(--success); }
        .j-text { text-align: center; font-size: 0.75rem; margin-top: 4px; font-weight: bold; color: #666; }

        .info-btn { position: absolute; top: 10px; right: 10px; background: #333; color: #fff; border:none; width:25px; height:25px; border-radius:50%; font-weight:bold; z-index: 10;}
        .modal { display: none; position: fixed; z-index: 100; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); }
        .modal-content { background: var(--panel); margin: 10% auto; padding: 20px; width: 90%; max-width: 450px; border-radius: 8px; border: 1px solid #444; max-height: 80vh; overflow-y: auto; }
        
        .target-list { list-style: none; padding: 0; margin: 10px 0; }
        .target-item { display: flex; justify-content: space-between; background: #2d2d2d; padding: 10px; margin-bottom: 5px; border-radius: 4px; align-items: center;}
        .target-item button { background: var(--danger); border: none; color: white; width: 25px; height: 25px; border-radius: 4px; cursor: pointer; }
        
        .hidden { display: none; }
    </style>
</head>
<body>

<div class="container">
    <button class="info-btn" onclick="openInfo()">i</button>
    
    <div class="tab-bar">
        <button class="tab active" id="tabDist" onclick="setTab('dist')">Laske Et√§isyys</button>
        <button class="tab" id="tabSize" onclick="setTab('size')">Laske Koko</button>
    </div>

    <div class="content-area">
        <div class="btn-group">
            <select id="profileSelector" onchange="loadProfile()" style="flex: 3; background: transparent; border: none;">
                <option value="">-- Valitse Profiili --</option>
            </select>
            <button class="btn btn-save" onclick="saveProfile()">TAL</button>
            <button class="btn btn-del" onclick="deleteProfile()">X</button>
        </div>

        <div style="margin-bottom: 15px; border-bottom: 1px solid #333; padding-bottom: 15px;">
            <label>Oma Sijainti (WGS84)</label>
            <div class="row" style="margin-bottom: 5px;">
                <div class="coord-group col">
                    <input type="number" id="latD" placeholder="Lat ¬∞" oninput="calc()">
                    <input type="number" id="latM" placeholder="'" oninput="calc()">
                    <input type="number" id="latS" placeholder='"' oninput="calc()">
                </div>
            </div>
            <div class="row">
                <div class="coord-group col">
                    <input type="number" id="lonD" placeholder="Lon ¬∞" oninput="calc()">
                    <input type="number" id="lonM" placeholder="'" oninput="calc()">
                    <input type="number" id="lonS" placeholder='"' oninput="calc()">
                </div>
            </div>
            <button id="btnGps" class="sensor-btn" onclick="toggleGPS()"><span>üìç</span> GPS</button>

            <div class="row" style="margin-top:15px;">
                <div class="col" style="flex: 2;">
                    <label>T√§hystyssuunta</label>
                    <input type="number" id="azimuth" placeholder="Suunta" oninput="calc()">
                </div>
                <div class="col" style="flex: 1;">
                    <label>Yksikk√∂</label>
                    <select id="azUnit" onchange="calc()">
                        <option value="mil">Mil</option>
                        <option value="deg">Deg</option>
                        <option value="piiru">PV</option>
                    </select>
                </div>
            </div>
            <button id="btnCompass" class="sensor-btn" onclick="toggleCompass()"><span>üß≠</span> Kompassi</button>
        </div>

        <div class="row">
            <div class="col" style="flex:2;">
                <label>Kameran FOV</label>
                <input type="number" id="fov" placeholder="FOV" oninput="calc()">
            </div>
            <div class="col" style="flex:1.5;">
                <label>Yksikk√∂</label>
                <select id="fovUnit" onchange="calc()">
                    <option value="deg">¬∞</option>
                    <option value="mil">Mil</option>
                    <option value="piiru">PV</option>
                    <option value="mrad">Mrad</option>
                </select>
            </div>
            <div class="col" style="flex:1.5;">
                <label>Kuva px</label>
                <input type="number" id="res" value="1920" oninput="calc()">
            </div>
        </div>

        <div id="viewDist">
            <div class="row">
                <div class="col" style="flex: 2.5;">
                    <label>Valitse Maali (m)</label>
                    <div style="display:flex; gap:5px;">
                        <select id="targetSelect" onchange="applyTarget()" style="flex:1;">
                            <option value="" disabled selected>‚ñæ</option>
                        </select>
                        <button onclick="openTargetManager()" style="background:#333; border:1px solid #444; color:#fff; border-radius:4px;">‚öô</button>
                    </div>
                </div>
                <div class="col" style="flex: 1.5;">
                     <label>Koko (m)</label>
                     <input type="number" id="tReal" placeholder="m" oninput="calc()">
                </div>
            </div>
        </div>

        <div id="viewSize" class="hidden">
            <div class="row">
                <div class="col">
                    <label>Tunnettu Et√§isyys (m)</label>
                    <input type="number" id="knownDist" placeholder="Et√§isyys" oninput="calc()">
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col" style="flex: 1.5;">
                <label>Maali px</label>
                <input type="number" id="tPx" placeholder="px" oninput="calc()">
            </div>
            <div class="col" style="flex: 1.5;">
                <label>Koro (¬∞)</label>
                <input type="number" id="elev" placeholder="¬±deg" oninput="calc()">
            </div>
        </div>

        <div class="result-box">
            <div id="resGroupDist">
                <div class="res-row"><span class="res-label">Viistoet√§isyys</span><span class="res-val" id="rSlant">---</span></div>
                <div class="res-row"><span class="res-label">Maastoet√§isyys</span><span class="res-val res-highlight" id="rGround">---</span></div>
            </div>
            <div id="resGroupSize" class="hidden">
                <div class="res-row"><span class="res-label">Maalin leveys</span><span class="res-val res-highlight" id="rSize">---</span></div>
            </div>
            <div class="res-row"><span class="res-label">Korkeusero</span><span class="res-val" id="rHeight">---</span></div>
            
            <div style="margin-top:12px; border-top:1px solid #444; padding-top:8px;">
                <div class="res-label" style="text-align:center; margin-bottom:4px;">MAALIN MGRS</div>
                <div id="rMgrs" class="mgrs-box">---</div>
                
                <div class="res-label" style="text-align:center; margin-top:8px;">GRID SIIRTYM√Ñ</div>
                <div id="rShift" style="color:#e0e0e0; font-family:monospace; font-size:1rem; text-align:center;">---</div>
            </div>

            <div class="meter"><div id="j1" class="step"></div><div id="j2" class="step"></div><div id="j3" class="step"></div></div>
            <div id="jTxt" class="j-text">---</div>

            <button class="share-btn" onclick="shareData()">
                üì§ Jaa havainto
            </button>
        </div>
    </div>
</div>

<div id="targetModal" class="modal">
    <div class="modal-content">
        <h3 style="margin-top:0;">Maalikirjasto</h3>
        <ul id="targetList" class="target-list"></ul>
        <div class="row">
            <input type="text" id="newTgtName" placeholder="Nimi">
            <input type="number" id="newTgtSize" placeholder="Lev. m" style="width:80px;">
        </div>
        <button class="sensor-btn" onclick="addTarget()" style="margin-top:10px; background:var(--success); color:white;">+ Lis√§√§</button>
        <button class="sensor-btn" onclick="document.getElementById('targetModal').style.display='none'" style="margin-top:20px;">Sulje</button>
    </div>
</div>

<div id="infoModal" class="modal" onclick="this.style.display='none'">
    <div class="modal-content">
        <h3>Ohjeet</h3>
        <p><strong>MGRS:</strong> Laskuri muuntaa WGS84-koordinaatit automaattisesti MGRS-ruudukkoon.</p>
        <p><strong>Jaa:</strong> Jakaa havainnon tekstimuodossa muihin sovelluksiin.</p>
        <p style="text-align:right; margin-top:20px; color:#2980b9;">Sulje</p>
    </div>
</div>

<script>
    if ('serviceWorker' in navigator) navigator.serviceWorker.register('./sw.js').catch(console.error);

    let mode = 'dist'; 
    const defaultTargets = [{n:"Mies (hartiat)",s:0.5},{n:"Mies (pituus)",s:1.8},{n:"Henkil√∂auto",s:1.8},{n:"BTR / Pas",s:2.9},{n:"Kuorma-auto",s:2.5},{n:"Lennokki",s:2.5},{n:"H√§vitt√§j√§",s:15.0},{n:"Matkustajakone",s:60.0}];
    let targets = JSON.parse(localStorage.getItem('tj_targets') || JSON.stringify(defaultTargets));

    function initTargets() {
        const sel = document.getElementById('targetSelect'); sel.innerHTML='<option value="" disabled selected>‚ñæ Valitse</option>';
        targets.forEach(t=>{let o=document.createElement('option');o.value=t.s;o.text=`${t.n} (${t.s}m)`;sel.add(o);});
        const l = document.getElementById('targetList'); l.innerHTML='';
        targets.forEach((t,i)=>{let li=document.createElement('li');li.className='target-item';li.innerHTML=`<span>${t.n} (${t.s}m)</span> <button onclick="delT(${i})">X</button>`;l.appendChild(li);});
    }
    function addTarget(){
        const n=document.getElementById('newTgtName').value, s=parseFloat(document.getElementById('newTgtSize').value);
        if(n&&s){targets.push({n:n,s:s}); localStorage.setItem('tj_targets',JSON.stringify(targets)); initTargets(); document.getElementById('newTgtName').value='';document.getElementById('newTgtSize').value='';}
    }
    function delT(i){if(confirm('Poista?')){targets.splice(i,1); localStorage.setItem('tj_targets',JSON.stringify(targets)); initTargets();}}
    function applyTarget(){document.getElementById('tReal').value=document.getElementById('targetSelect').value; calc();}
    function openTargetManager(){document.getElementById('targetModal').style.display='block';}

    function setTab(m){
        mode=m;
        document.getElementById('tabDist').className=m==='dist'?'tab active':'tab';
        document.getElementById('tabSize').className=m==='size'?'tab active':'tab';
        document.getElementById('viewDist').className=m==='dist'?'':'hidden';
        document.getElementById('viewSize').className=m==='size'?'':'hidden';
        document.getElementById('resGroupDist').className=m==='dist'?'':'hidden';
        document.getElementById('resGroupSize').className=m==='size'?'':'hidden';
        calc();
    }

    const toRad=d=>d*Math.PI/180, toDeg=r=>r*180/Math.PI;
    function getRad(v,u){if(!v)return 0; if(u==='deg')return toRad(v); if(u==='mil')return v*(2*Math.PI/6400); if(u==='piiru')return v*(2*Math.PI/6000); return v/1000;}

    // MAIN CALC
    function calc() {
        const fov = parseFloat(document.getElementById('fov').value);
        const res = parseFloat(document.getElementById('res').value);
        const tPx = parseFloat(document.getElementById('tPx').value);
        const elev = parseFloat(document.getElementById('elev').value) || 0;
        let ground = 0;

        if(!fov || !res || !tPx) { resetRes(); return; }
        const angle = (getRad(fov, document.getElementById('fovUnit').value) / res) * tPx;

        if (mode === 'dist') {
            const tReal = parseFloat(document.getElementById('tReal').value);
            if(!tReal) { resetRes(); return; }
            const slant = (tReal / 2) / Math.tan(angle / 2);
            ground = slant * Math.cos(toRad(elev));
            const height = slant * Math.sin(toRad(elev));
            document.getElementById('rSlant').innerText = slant.toFixed(0) + " m";
            document.getElementById('rGround').innerText = Math.abs(ground).toFixed(0) + " m";
            document.getElementById('rHeight').innerText = (height>0?"+":"") + height.toFixed(0) + " m";
        } else {
            const knownDist = parseFloat(document.getElementById('knownDist').value);
            if(!knownDist) { resetRes(); return; }
            const slant = knownDist / Math.cos(toRad(elev));
            const size = 2 * slant * Math.tan(angle / 2);
            document.getElementById('rSize').innerText = size.toFixed(2) + " m";
            ground = knownDist;
            const height = slant * Math.sin(toRad(elev));
            document.getElementById('rHeight').innerText = (height>0?"+":"") + height.toFixed(0) + " m";
        }

        updateJohnson(tPx);
        calcCoords(ground);
    }

    function resetRes() {
        document.getElementById('rSlant').innerText="---"; document.getElementById('rGround').innerText="---"; 
        document.getElementById('rSize').innerText="---"; document.getElementById('rMgrs').innerText="---";
    }
    
    // --- SHARE FUNCTION ---
    function shareData() {
        const mgrs = document.getElementById('rMgrs').innerText;
        const ground = document.getElementById('rGround').innerText;
        const height = document.getElementById('rHeight').innerText;
        const note = mode === 'dist' ? `MAALI: ${mgrs}` : `HAVAINTO: ${mgrs}`;
        
        const shareText = `${note}\nET√ÑISYYS: ${ground}\nKORKEUS: ${height}\nTJ-Laskuri`;

        if (navigator.share) {
            navigator.share({ title: 'Havainto', text: shareText }).catch(console.error);
        } else {
            navigator.clipboard.writeText(shareText).then(() => alert("Kopioitu leikep√∂yd√§lle!"));
        }
    }

    // --- COORD & MGRS LOGIC ---
    function calcCoords(dist) {
        const latD=parseFloat(document.getElementById('latD').value), latM=parseFloat(document.getElementById('latM').value)||0, latS=parseFloat(document.getElementById('latS').value)||0;
        const lonD=parseFloat(document.getElementById('lonD').value), lonM=parseFloat(document.getElementById('lonM').value)||0, lonS=parseFloat(document.getElementById('lonS').value)||0;
        const azVal=parseFloat(document.getElementById('azimuth').value);

        if(!azVal) { document.getElementById('rShift').innerText="---"; document.getElementById('rMgrs').innerText="---"; return; }

        const azRad = getRad(azVal, document.getElementById('azUnit').value);
        const dN = dist * Math.cos(azRad), dE = dist * Math.sin(azRad);
        document.getElementById('rShift').innerText = `N: ${dN>0?'+':''}${dN.toFixed(0)}m  E: ${dE>0?'+':''}${dE.toFixed(0)}m`;

        if(!latD || !lonD) return;
        const lat1 = toRad(latD + latM/60 + latS/3600);
        const lon1 = toRad(lonD + lonM/60 + lonS/3600);
        const R = 6371000;
        const lat2 = Math.asin(Math.sin(lat1)*Math.cos(dist/R) + Math.cos(lat1)*Math.sin(dist/R)*Math.cos(azRad));
        const lon2 = lon1 + Math.atan2(Math.sin(azRad)*Math.sin(dist/R)*Math.cos(lat1), Math.cos(dist/R)-Math.sin(lat1)*Math.sin(lat2));
        
        // Convert to MGRS
        try {
            const mgrs = forward(toDeg(lat2), toDeg(lon2));
            document.getElementById('rMgrs').innerText = mgrs;
        } catch(e) {
            document.getElementById('rMgrs').innerText = "Err";
        }
    }

    // --- LIGHTWEIGHT MGRS CONVERTER (Embedded) ---
    // Based on standard UTM/MGRS math logic
    function forward(lat, lon) {
        if (lat < -80 || lat > 84) return "Polar region";
        const ZONE = Math.floor((lon + 180) / 6) + 1;
        const N0 = lat >= 0 ? 0 : 10000000;
        const k0 = 0.9996;
        const a = 6378137.0; // WGS84
        const f = 1 / 298.257223563;
        const b = a * (1 - f);
        const e = Math.sqrt(1 - (b * b) / (a * a));
        const e1sq = e * e / (1 - e * e);
        
        const latRad = toRad(lat);
        const lonRad = toRad(lon);
        const lonOrigin = toRad((ZONE - 1) * 6 - 180 + 3);

        const N = a / Math.sqrt(1 - Math.pow(e * Math.sin(latRad), 2));
        const T = Math.pow(Math.tan(latRad), 2);
        const C = e1sq * Math.pow(Math.cos(latRad), 2);
        const A = (lonRad - lonOrigin) * Math.cos(latRad);
        const M = a * ((1 - Math.pow(e, 2) / 4 - 3 * Math.pow(e, 4) / 64 - 5 * Math.pow(e, 6) / 256) * latRad - (3 * Math.pow(e, 2) / 8 + 3 * Math.pow(e, 4) / 32 + 45 * Math.pow(e, 6) / 1024) * Math.sin(2 * latRad) + (15 * Math.pow(e, 4) / 256 + 45 * Math.pow(e, 6) / 1024) * Math.sin(4 * latRad) - (35 * Math.pow(e, 6) / 3072) * Math.sin(6 * latRad));

        const easting = k0 * N * (A + (1 - T + C) * Math.pow(A, 3) / 6 + (5 - 18 * T + T * T + 72 * C - 58 * e1sq) * Math.pow(A, 5) / 120) + 500000.0;
        const northing = k0 * (M + N * Math.tan(latRad) * (A * A / 2 + (5 - T + 9 * C + 4 * C * C) * Math.pow(A, 4) / 24 + (61 - 58 * T + T * T + 600 * C - 330 * e1sq) * Math.pow(A, 6) / 720)) + N0;

        return getMgrsString(ZONE, lat, easting, northing);
    }

    function getMgrsString(zone, lat, e, n) {
        // GZD Letter
        const letters = "CDEFGHJKLMNPQRSTUVWXX"; 
        const latIndex = Math.floor((lat + 80) / 8);
        let gzd = letters[latIndex];
        if(lat > 84) gzd = 'X'; 

        // 100km Square
        const set = zone % 6;
        const digraphs = "ABCDEFGHJKLMNPQRSTUVWXYZ";
        // Calculate col/row for 100k square
        const e100k = Math.floor(e / 100000);
        const n100k = Math.floor(n / 100000) % 20;
        
        // Simplified Logic for standard zones (skipping complex band exceptions for brevity in single-file)
        // This covers standard operating areas well.
        // Col:
        let colOffset = (set - 1) * 8; 
        let colLet = digraphs[(colOffset + e100k - 1) % 24]; // Approx logic
        // Row:
        let rowOffset = (set % 2 === 0) ? 5 : 0; 
        let rowLet = digraphs[(rowOffset + n100k) % 20];

        // Format 5 digit precision
        const eStr = Math.floor(e % 100000).toString().padStart(5, '0');
        const nStr = Math.floor(n % 100000).toString().padStart(5, '0');

        // Note: The letter logic above is a simplified approximation for common zones.
        // For mission critical precision across all zone boundaries, external library is safer,
        // but this works for local calculations.
        
        // Let's use a simpler known standard array for 100km letters to be safer:
        const mgrs = `${zone}${gzd} ${get100kID(zone, e, n)} ${eStr} ${nStr}`;
        return mgrs;
    }

    function get100kID(zone, easting, northing) {
       // Correct 100k letter math
       let set = zone % 6; if(set===0) set=6;
       const colBase = "ABCDEFGHJKLMNPQRSTUVWXYZ";
       const rowBase = "ABCDEFGHJKLMNPQRSTUV";
       
       // Col
       let colBlock = Math.floor(easting / 100000);
       // Handle edge cases
       if(colBlock < 1 || colBlock > 8) return "XX";
       
       let colIdx = (set - 1) * 8 + colBlock - 1;
       // Wrap letters excluding I and O
       const colL = getL(colBase, colIdx);

       // Row
       let rowBlock = Math.floor(northing / 100000);
       let rowOffset = (set % 2 === 0) ? 5 : 0;
       let rowIdx = (rowOffset + rowBlock) % 20;
       const rowL = rowBase[rowIdx];
       
       return colL + rowL;
    }
    
    function getL(base, idx) {
        // Skip I and O manually logic
        const valid = "ABCDEFGHJKLMNPQRSTUVWXYZ";
        return valid[idx % 24];
    }

    // --- SENSORS ---
    let wId=null;
    function toggleGPS(){
        const b=document.getElementById('btnGps');
        if(wId){navigator.geolocation.clearWatch(wId);wId=null;b.classList.remove('active');}
        else{b.classList.add('active');wId=navigator.geolocation.watchPosition(p=>{const l=p.coords.latitude,n=p.coords.longitude;const lp=splitD(l),lo=splitD(n);document.getElementById('latD').value=lp.d;document.getElementById('latM').value=lp.m;document.getElementById('latS').value=lp.s;document.getElementById('lonD').value=lo.d;document.getElementById('lonM').value=lo.m;document.getElementById('lonS').value=lo.s;calc();},e=>{alert('GPS Err');toggleGPS();},{enableHighAccuracy:true});}
    }
    function splitD(d){const a=Math.abs(d),x=Math.floor(a),m=Math.floor((a-x)*60),s=((a-x-m/60)*3600).toFixed(1);return{d:x*(d<0?-1:1),m:m,s:s};}
    let cAct=false;
    function toggleCompass(){const b=document.getElementById('btnCompass');if(cAct){window.removeEventListener('deviceorientation',hOr);cAct=false;b.classList.remove('active');}else{if(typeof DeviceOrientationEvent!=='undefined'&&typeof DeviceOrientationEvent.requestPermission==='function'){DeviceOrientationEvent.requestPermission().then(r=>{if(r==='granted')sC(b);});}else sC(b);}}
    function sC(b){window.addEventListener('deviceorientation',hOr);cAct=true;b.classList.add('active');}
    function hOr(e){let h=e.webkitCompassHeading||(e.alpha?360-e.alpha:0);if(h){if(h<0)h+=360;if(h>=360)h-=360;const u=document.getElementById('azUnit').value;let v=h;if(u==='mil')v=h*(6400/360);if(u==='piiru')v=h*(6000/360);document.getElementById('azimuth').value=Math.round(v);calc();}}
    
    // UTILS
    function updateJohnson(px){const j1=document.getElementById('j1'),j2=document.getElementById('j2'),j3=document.getElementById('j3'),t=document.getElementById('jTxt');j1.className=j2.className=j3.className="step";if(px<2){t.innerText="---";return;}j1.classList.add("active","l1");t.innerText="HAVAITSEMINEN";t.style.color="#c0392b";if(px>=8){j2.classList.add("active","l2");t.innerText="LUOKITTELU";t.style.color="#f39c12";}if(px>=13){j3.classList.add("active","l3");t.innerText="TUNNISTUS";t.style.color="#27ae60";}}
    function loadProfile(){const p=profs[document.getElementById('profileSelector').value];if(p){document.getElementById('fov').value=p.f;document.getElementById('res').value=p.r;document.getElementById('fovUnit').value=p.u;calc();}}
    let profs=JSON.parse(localStorage.getItem('tj_profs_v2')||'{}');
    function saveProfile(){const n=prompt("Nimi?");if(!n)return;profs[n]={f:document.getElementById('fov').value,r:document.getElementById('res').value,u:document.getElementById('fovUnit').value};localStorage.setItem('tj_profs_v2',JSON.stringify(profs));uSel();}
    function deleteProfile(){const n=document.getElementById('profileSelector').value;if(profs[n]){delete profs[n];localStorage.setItem('tj_profs_v2',JSON.stringify(profs));uSel();}}
    function uSel(){const s=document.getElementById('profileSelector');s.innerHTML='<option value="">-- Valitse Profiili --</option>';for(let k in profs){let o=document.createElement('option');o.value=k;o.text=k;s.add(o);}}
    function openInfo(){document.getElementById('infoModal').style.display='block';}
    window.onload=function(){uSel(); initTargets(); calc();}
</script>
</body>
</html>
